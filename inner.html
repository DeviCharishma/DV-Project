<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EV Data Visualizations</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>EV Charging Stations and Population in USA</h1>
        <div class="tabs">
          <button class="tab-btn active" data-tab="tab1">Usage Trends</button>
          <button class="tab-btn" data-tab="tab2">Station Map</button>
          <button class="tab-btn" data-tab="tab3">Performance Metrics</button>
        </div>
      </header>
      <main>
        <!-- Tab 1: Usage Trends -->
        <div id="tab1" class="tab-content active">
          <div class="visualization-container">
            <div class="visualization">
              <div id="altairEvRegistrationsChart" class="chart"></div>
            </div>
            <div class="conceptual-matter">
              <h3>EV Registrations by Model Year (Altair)</h3>
              <p>
                This line chart illustrates the growth of electric vehicle (EV) registrations by model year from 1997 to 2024. The data shows a steady increase until around 2015, after which the growth accelerates significantly. By 2024, registrations peaked at 1,805 vehicles, reflecting wider EV adoption driven by advances in technology, increased model availability, and supportive policies. The use of a line chart effectively highlights the upward trend and the sharp increase in recent years.
              </p>
            </div>
          </div>

          <div class="visualization-container">
            <div class="visualization">
              <div id="topCitiesChart" class="chart"></div>
            </div>
            <div class="conceptual-matter">
              <h3>Top Cities with Most EVs (Plotly)</h3>
              <p>
                West Coast cities dominate EV adoption, likely due to favorable
                climate for battery performance, state incentives, and higher
                concentration of charging infrastructure.
              </p>
            </div>
          </div>

          <div class="visualization-container">
            <div class="visualization">
              <div id="makeDistributionChart" class="chart"></div>
            </div>
            <div class="conceptual-matter">
              <h3>EV Count by Make (Plotly)</h3>
              <p>
                Tesla's first-mover advantage remains dominant, followed closely
                by Volvo in premium EV segments. The growing 'Other' category
                (now representing 28% of the market) signals healthy industry
                diversification beyond early leaders.
              </p>
              <p>
                Nissan maintains strong positioning through the Leaf's
                affordability, while Volvo's rapid ascent reflects successful
                electrification of their luxury lineup. This breakdown reveals
                three distinct market tiers:
              </p>
              <ol>
                <li>
                  <strong>Market Leaders</strong> (Tesla, Volvo) -
                  Premium/long-range focus
                </li>
                <li>
                  <strong>Mass Market</strong> (Nissan, Chevrolet) - Affordable
                  entry points
                </li>
                <li>
                  <strong>Emerging Brands</strong> - 14 manufacturers comprising
                  the 'Other' segment
                </li>
              </ol>
            </div>
          </div>

          <div class="visualization-container full-width-viz">
            <div class="visualization" style="height: 650px">
              <div class="chart-title">Top 12 Electric Vehicle Models</div>
              <div id="radial" class="chart-full"></div>
            </div>
            <div class="conceptual-matter">
              <h3>Popular EV Models (D3.js Radial Chart)</h3>
              <p>
                Model popularity reveals consumer priorities shifting in
                real-time. Early leaders like the Nissan Leaf succeeded by being
                affordable and 'good enough,' while today's top models combine
                300+ mile ranges with tech-forward features. The radial format
                highlights an important market dynamic - the top 3 models
                capture nearly half the market, yet the long tail shows more
                model diversity than the ICE vehicle market. This suggests EVs
                are simultaneously consolidating around winners while enabling
                more niche vehicles than ever before.
              </p>
            </div>
          </div>

          <div class="visualization-container full-width-viz">
            <div class="visualization">
              <div class="chart-title">EV Range vs Model Year</div>
              <svg id="bubble-chart" width="100%" height="600"></svg>
            </div>
            <div class="conceptual-matter">
              <h3>EV Range vs Model Year (D3.js)</h3>
              <p>
                Interactive bubble chart showing how electric ranges have
                improved over time, with bubble size representing charging
                station availability in each vehicle's area.
              </p>
            </div>
          </div>

          <div class="visualization-container full-width-viz">
            <div class="visualization">
              <div id="streamgraph" class="chart-full"></div>
            </div>
            <div class="conceptual-matter">
              <p>
                Streamgraph visualization showing Battery Electric Vehicles
                (BEVs) gaining market share over Plug-in Hybrids (PHEVs) as
                range anxiety decreases.
              </p>
              <p>
                The BEV/PHEV tug-of-war tells a deeper story about consumer
                psychology. PHEVs initially dominated as a 'transition
                technology,' but their decline began when BEVs crossed 250 miles
                of range - the point where most consumers stop considering range
                limitations. The recent stabilization suggests PHEVs will
                persist for specific use cases (like rural drivers) rather than
                disappear completely.
              </p>
            </div>
          </div>
        </div>

        <!-- Tab 2: Station Map -->
        <div id="tab2" class="tab-content">
          <div class="visualization-container full-width-viz">
            <div class="visualization">
              <div id="stationMap" class="chart-full"></div>
            </div>
            <div class="conceptual-matter">
              <h3>EV Stations by Location (Plotly Mapbox)</h3>
              <p>
                Geographical distribution shows charging stations concentrated
                in urban areas and along major highways, with color coding
                revealing regional brand preferences.
              </p>
            </div>
          </div>

          <div class="visualization-container full-width-viz">
            <div class="visualization">
              <div
                id="altairDistrictRegistrationsChart"
                class="chart-full"
              ></div>
            </div>
            <div class="conceptual-matter">
              <h3>EV Registrations by District (Altair)</h3>
              <p>
                This bar chart shows the distribution of EV registrations across
                legislative districts. The data is sorted in descending order,
                highlighting District 41 as the leader with 878 EVs registered.
                A blue color gradient represents the count of registrations,
                with darker shades indicating higher values.
              </p>
              <p>
                This visualization makes it easy to compare adoption rates
                between districts and reveals that a small number of districts
                account for the majority of EV registrations. Such patterns
                often correlate with factors like higher income levels, state
                incentives, and EV-friendly infrastructure.
              </p>
            </div>
          </div>

          <div class="visualization-container full-width-viz">
            <div class="visualization">
              <div id="barchart" class="chart-full"></div>
            </div>
            <div class="conceptual-matter">
              <h3>
                Charging Infrastructure Balance (D3.js Horizontal Diverging Bar
                Chart)
              </h3>
              <p>
                This visualization compares the number of EVs versus charging
                stations in different ZIP codes. Red bars show areas where
                charging infrastructure may be inadequate (more EVs than
                stations). The length of each bar represents the difference
                between stations and EVs.
              </p>
            </div>
          </div>
        </div>

        <!-- Tab 3: Performance Metrics -->
        <div id="tab3" class="tab-content">
          <div class="visualization-container">
            <div class="visualization">
              <div id="rangeDistributionChart" class="chart"></div>
            </div>
            <div class="conceptual-matter">
              <h3>Electric Range Distribution (Plotly)</h3>
              <p>
                Most EVs cluster in the 100-250 mile range, with premium models
                forming a secondary peak around 300+ miles - covering typical
                daily needs with margin.
              </p>
            </div>
          </div>

          <div class="visualization-container">
            <div class="visualization">
              <div id="rangeScatterPlot" class="chart"></div>
            </div>
            <div class="conceptual-matter">
              <h3>Range vs Model Year (Plotly)</h3>
              <p>
                Clear upward trajectory in ranges across all manufacturers, with
                Tesla maintaining an advantage and brands showing distinct range
                strategies.
              </p>
            </div>
          </div>

          <div class="visualization-container full-width-viz">
            <div class="visualization">
              <div id="altairCorrelationChart" class="chart-full"></div>
            </div>
            <div class="conceptual-matter">
              <h3>EV Feature Correlation Matrix (Altair: Vega-Lite)</h3>
              <p>
                This heatmap reveals key relationships between EV range and
                geographic distribution. The strongest correlation (Electric
                Range â†” Latitude) suggests climate influences battery
                performance, while weaker longitude links may reflect charging
                infrastructure patterns. Notably, range shows minimal
                correlation with itself - a data quirk worth investigating.
              </p>
            </div>
          </div>
        </div>
      </main>
    </div>
    <script src="script.js"></script>
    <script>
      function createRangeDistributionChart(data) {
        const electricRanges = data
          .map((entry) => parseFloat(entry["Electric Range"]))
          .filter((val) => !isNaN(val));

        const trace = {
          x: electricRanges,
          type: "histogram",
          nbinsx: 30,
          marker: { color: "blue" },
          hovertemplate: "Electric Range: %{x}<br>Count: %{y}<extra></extra>",
        };

        const layout = {
          title: "Distribution of Electric Vehicle Ranges",
          xaxis: { title: "Electric Range" },
          yaxis: { title: "Count" },
          margin: { t: 50, l: 50, r: 30, b: 50 },
        };

        Plotly.newPlot("rangeDistributionChart", [trace], layout);
      }

      function createAltairEvRegistrationsChart(data) {
        const yearCounts = {};
        data.forEach((entry) => {
          const year = entry["Model Year"];
          if (year && +year <= 2024) {
            // Only up to year 2024
            yearCounts[year] = (yearCounts[year] || 0) + 1;
          }
        });

        const chartData = Object.keys(yearCounts)
          .map((year) => ({
            "Model Year": year,
            Count: yearCounts[year],
          }))
          .sort((a, b) => a["Model Year"] - b["Model Year"]);

        const spec = {
          $schema: "https://vega.github.io/schema/vega-lite/v5.json",
          title: "EV Registrations by Model Year (Up to 2024)",
          data: { values: chartData },
          mark: { type: "line", point: true },
          encoding: {
            x: {
              field: "Model Year",
              type: "ordinal",
              axis: { title: "Model Year" },
            },
            y: {
              field: "Count",
              type: "quantitative",
              axis: { title: "Count" },
            },
            tooltip: [{ field: "Model Year" }, { field: "Count" }],
          },
          width: 600,
          height: 400,
        };

        vegaEmbed("#altairEvRegistrationsChart", spec);
      }

      function createAltairDistrictRegistrationsChart(data) {
        const districtCounts = {};
        data.forEach((entry) => {
          const district = entry["Legislative District"];
          if (district) {
            districtCounts[district] = (districtCounts[district] || 0) + 1;
          }
        });

        const chartData = Object.keys(districtCounts)
          .map((district) => ({
            "Legislative District": district,
            Count: districtCounts[district],
          }))
          .sort((a, b) => b.Count - a.Count);

        const spec = {
          $schema: "https://vega.github.io/schema/vega-lite/v5.json",
          title: {
            text: "EV Registrations by Legislative District",
            fontSize: 18,
            anchor: "start",
          },
          data: { values: chartData },
          mark: "bar",
          encoding: {
            x: {
              field: "Legislative District",
              type: "ordinal",
              sort: "-y",
              axis: {
                title: "Legislative District",
                labelAngle: -45,
                labelFontSize: 12,
                titleFontSize: 14,
              },
            },
            y: {
              field: "Count",
              type: "quantitative",
              title: "Number of EVs Registered",
            },
            color: {
              field: "Count",
              type: "quantitative",
              scale: { scheme: "blues" },
            },
            tooltip: [
              { field: "Legislative District", type: "ordinal" },
              { field: "Count", type: "quantitative" },
            ],
          },
          width: 1000,
          height: 400,
          config: {
            view: { stroke: null },
          },
        };

        vegaEmbed("#altairDistrictRegistrationsChart", spec);
      }

      function createTopCitiesChart(data) {
        const cityCounts = {};
        data.forEach((entry) => {
          const city = entry["City"];
          if (city) {
            cityCounts[city] = (cityCounts[city] || 0) + 1;
          }
        });

        const sortedCities = Object.entries(cityCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 15);

        const cities = sortedCities.map((item) => item[0]);
        const counts = sortedCities.map((item) => item[1]);

        const trace = {
          y: counts,
          x: cities,
          type: "bar",
          orientation: "v",
          marker: {
            color: cities.map((_, i) => `hsl(${i * 24}, 100%, 50%)`),
          },
          hovertemplate: "City: %{x}<br>Count: %{y}<extra></extra>",
        };

        const layout = {
          title: "Top 15 Cities with Most EVs",
          xaxis: { title: "City" },
          yaxis: { title: "Count" },
          margin: { t: 50, l: 80, r: 30, b: 120 },
          showlegend: false,
        };

        Plotly.newPlot("topCitiesChart", [trace], layout);
      }

      function createMakeDistributionChart(data) {
        const makeCounts = {};
        data.forEach((entry) => {
          const make = entry["Make"];
          if (make) {
            makeCounts[make] = (makeCounts[make] || 0) + 1;
          }
        });

        // Convert to array and sort
        const makeData = Object.entries(makeCounts)
          .sort((a, b) => b[1] - a[1])
          .map(([make, count]) => ({ make, count }));

        // Group small makes into "Other" category
        const threshold = Math.max(10, makeData[0].count * 0.03);
        const mainMakes = makeData.filter((d) => d.count >= threshold);
        const otherMakes = makeData.filter((d) => d.count < threshold);

        const otherCount = otherMakes.reduce((sum, d) => sum + d.count, 0);
        const finalData = [...mainMakes];
        if (otherCount > 0) {
          finalData.push({ make: "Other", count: otherCount });
        }

        const trace = {
          labels: finalData.map((d) => d.make),
          values: finalData.map((d) => d.count),
          type: "pie",
          hole: 0.5,
          textinfo: "none",
          hovertemplate:
            "<b>%{label}</b><br>" +
            "EV Count: %{value}<br>" +
            "Percentage of Total: %{percent}<extra></extra>", // Clear labeling
          marker: {
            colors: finalData.map(
              (_, i) => `hsl(${(i * 360) / finalData.length}, 70%, 50%)`
            ),
          },
        };

        const layout = {
          title: "EV Count by Make",
          showlegend: true,
          legend: {
            orientation: "v",
            y: 0.5,
          },
          margin: { t: 50, l: 0, r: 0, b: 0 },
          hoverlabel: {
            bgcolor: "white",
            font: { size: 14 },
          },
        };

        Plotly.newPlot("makeDistributionChart", [trace], layout);
      }

      function createAltairCorrelationChart(data) {
        const spec = {
          $schema: "https://vega.github.io/schema/vega-lite/v5.json",
          description: "Correlation Matrix Heatmap",
          data: {
            values: [
              {
                Feature1: "Electric Range",
                Feature2: "Electric Range",
                Correlation: 1.0,
              },
              {
                Feature1: "Electric Range",
                Feature2: "Longitude",
                Correlation: 0.2,
              },
              {
                Feature1: "Electric Range",
                Feature2: "Latitude",
                Correlation: 0.1,
              },
              {
                Feature1: "Longitude",
                Feature2: "Electric Range",
                Correlation: 0.2,
              },
              {
                Feature1: "Longitude",
                Feature2: "Longitude",
                Correlation: 1.0,
              },
              { Feature1: "Longitude", Feature2: "Latitude", Correlation: 0.8 },
              {
                Feature1: "Latitude",
                Feature2: "Electric Range",
                Correlation: 0.1,
              },
              { Feature1: "Latitude", Feature2: "Longitude", Correlation: 0.8 },
              { Feature1: "Latitude", Feature2: "Latitude", Correlation: 1.0 },
            ],
          },
          mark: "rect",
          encoding: {
            x: { field: "Feature1", type: "nominal" },
            y: { field: "Feature2", type: "nominal" },
            color: { field: "Correlation", type: "quantitative" },
            tooltip: [
              { field: "Feature1", type: "nominal" },
              { field: "Feature2", type: "nominal" },
              { field: "Correlation", type: "quantitative" },
            ],
          },
          width: 600,
          height: 600,
          title: "Correlation Matrix Heatmap",
        };

        vegaEmbed("#altairCorrelationChart", spec);
      }

      function createStationMap(data) {
        const filteredData = data.filter(
          (entry) =>
            entry.Latitude &&
            entry.Longitude &&
            !isNaN(parseFloat(entry.Latitude)) &&
            !isNaN(parseFloat(entry.Longitude))
        );

        const stationCounts = {};
        filteredData.forEach((entry) => {
          const key = `${entry.Latitude},${entry.Longitude}`;
          stationCounts[key] = (stationCounts[key] || 0) + 1;
        });

        const mapData = filteredData.map((entry) => {
          const key = `${entry.Latitude},${entry.Longitude}`;
          return {
            ...entry,
            Station_Count: stationCounts[key],
            Latitude: parseFloat(entry.Latitude),
            Longitude: parseFloat(entry.Longitude),
          };
        });

        const seen = new Set();
        const uniqueMapData = [];
        mapData.forEach((entry) => {
          const key = `${entry.Latitude},${entry.Longitude}`;
          if (!seen.has(key)) {
            seen.add(key);
            uniqueMapData.push(entry);
          }
        });

        const makes = [...new Set(uniqueMapData.map((d) => d.Make))];
        const colors = {};
        makes.forEach((make, i) => {
          colors[make] = `hsl(${(i * 360) / makes.length}, 70%, 50%)`;
        });

        const traces = makes.map((make) => {
          const entries = uniqueMapData.filter((d) => d.Make === make);
          return {
            type: "scattermapbox",
            mode: "markers",
            name: make,
            lat: entries.map((d) => d.Latitude),
            lon: entries.map((d) => d.Longitude),
            customdata: entries.map((d) => [d.Make, d.Model, d.Station_Count]),
            marker: {
              size: entries.map((d) => Math.min(d.Station_Count * 5, 30)),
              color: colors[make],
              opacity: 0.7,
            },
            hovertemplate:
              "Make: %{customdata[0]}<br>Model: %{customdata[1]}<br>Stations Nearby: %{customdata[2]}<extra></extra>",
          };
        });

        const layout = {
          mapbox: {
            style: "open-street-map",
            center: { lat: 47.5, lon: -120 },
            zoom: 5,
          },
          title: "EV Stations by Location and Make",
          height: 500,
          margin: { r: 0, t: 40, l: 0, b: 0 },
          legend: {
            title: { text: "Make" },
            orientation: "v",
          },
        };

        Plotly.newPlot("stationMap", traces, layout);
      }

      function createRangeScatterPlot(data) {
        const filteredData = data.filter(
          (entry) =>
            entry["Model Year"] &&
            entry["Electric Range"] &&
            !isNaN(parseFloat(entry["Electric Range"])) &&
            !isNaN(parseInt(entry["Model Year"]))
        );

        const makes = [...new Set(filteredData.map((entry) => entry.Make))];
        const colorScale = {};
        makes.forEach((make, i) => {
          colorScale[make] = `hsl(${i * (360 / makes.length)}, 70%, 50%)`;
        });

        const traces = makes.map((make) => {
          const entries = filteredData.filter((entry) => entry.Make === make);
          return {
            x: entries.map((entry) => parseInt(entry["Model Year"])),
            y: entries.map((entry) => parseFloat(entry["Electric Range"])),
            mode: "markers",
            type: "scatter",
            name: make,
            marker: { color: colorScale[make], size: 8, opacity: 0.7 },
            text: entries.map(
              (entry) =>
                `Make: ${entry.Make}<br>Model: ${entry.Model}<br>Year: ${entry["Model Year"]}<br>Range: ${entry["Electric Range"]} mi`
            ),
            hoverinfo: "text",
          };
        });

        const layout = {
          title: "Electric Range over Model Years",
          xaxis: { title: "Model Year" },
          yaxis: { title: "Electric Range" },
          hovermode: "closest", // Fix hover to only the closest point
          legend: { title: { text: "Make" } },
          margin: { t: 50, l: 60, r: 30, b: 50 },
        };

        Plotly.newPlot("rangeScatterPlot", traces, layout);
      }

      // fetch data and create visualizations
      const gistUrl =
        "https://gist.githubusercontent.com/DeviCharishma/ab31bb680acf271a983617dd7c833595/raw/b8aead2f470453f09ea81ae5600f356215a13835/gistfile1.txt";

      fetch(gistUrl)
        .then((response) => response.text())
        .then((csvData) => {
          const lines = csvData.split("\n");
          const headers = lines[0].split(",");
          const data = [];

          for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim() === "") continue;
            const values = lines[i].split(",");
            const entry = {};
            for (let j = 0; j < headers.length; j++) {
              entry[headers[j]] = values[j];
            }
            data.push(entry);
          }

          // all functions are defined before being called
          createRangeDistributionChart(data);
          createAltairEvRegistrationsChart(data);
          createTopCitiesChart(data);
          createMakeDistributionChart(data);
          createAltairDistrictRegistrationsChart(data);
          createAltairCorrelationChart(data);
          createStationMap(data);
          createRangeScatterPlot(data);
        })
        .catch((error) => console.error("Error loading data:", error));
    </script>
    <script src="D3V.js"></script>
  </body>
  <a href="index.html" class="btn">Back to Main</a>
</html>
